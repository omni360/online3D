
ï»¿var startup=new(function(){"use strict";window.indexedFiles.openbase();var _this=this;var rootMap={"STL":"/Stl/StlView"}
var supportedExtensions=["STL"];function extensionIsOk(files){var firstExtension=undefined;for(var i=0;i<files.length;i++){var extension=files[i].name.split('.').pop().toUpperCase();if(firstExtension===undefined)
firstExtension=extension;else{if(firstExtension!==extension)
return false;}
if($.inArray(extension,supportedExtensions)<0)
return false;}
return true;}
this.openFileDialog=function(){$("#fileLoader").click();}
this.openDropboxDrive=function(){var options={linkType:"direct",success:function(files){console.log(files);var clientOptions={key:'254hrzt7wfhcmxv',secret:'i9f2dtdx5y67wui',sandbox:true,authCheck:function(isAuthorized,client){if(isAuthorized){for(var i=0;i<files.length;i++){var file=files[i];client.readFile(file.link,function(error,data){if(error){return console.log(error);}
alert(data);});}}else{console.log("need authentication");}}};var client=new Dropbox.Client(clientOptions);},cancel:function(){}};Dropbox.choose(options);}
this.openSkyDrive=function(){var fileSelected=function(){}
var fileDownloaded=function(){}
skydrive.showUI(fileSelected,fileDownloaded);}
this.openGoogleDrive=function(){var fileSelected=function(){}
var fileDownloaded=function(){}
gdrive.showUI(fileSelected,fileDownloaded);}
function addToStore(fileData,nextcall){return window.indexedFiles.addFile(fileData,nextcall);}
function showProgress(show){var visibilityProgress=(show)?'visible':'hidden';var visibilityRest=(show)?'hidden':'visible';$("#db_progress").css({visibility:visibilityProgress});$("#intro_text").css({visibility:visibilityRest});$("#selectfile_button").css({visibility:visibilityRest});}
function loadFiles(files){if(!compatibilityChecks())
return;if(files.length==0)
return;if(files){showProgress(true);var index=files.length;var runLoad=function(){index--;if(index<0){window.indexedFiles.deletebase();(function(file){var extension=file.name.split('.').pop();var path=rootMap[extension.toUpperCase()];if(path){window.location.replace(path);}})(files[0]);}
var file=files[index];var reader=new FileReader();reader.onload=function(event){var data=event.target.result;if(reader.readyState==2){var fileData={"fileName":file.name,"fileSize":file.size,"fileData":data}
if(addToStore(fileData,runLoad)===false){toastr.error('Failed to load file '+file.name,'Error');showProgress(false);}}
else{toastr.error('Can not initialize GL engine','Error');showProgress(false);}};reader.onerror=function(event){console.error("File could not be read! Error code: "+event.target.error.code);toastr.error('Failed to load file '+file.name+' Error: '+event.target.error.toString(),'Error');showProgress(false);};reader.readAsBinaryString(file);};runLoad();}
else{toastr.error('Can not load file: '+file.name,'Error');}}
function loadFileFromDrop(event){var files=event.dataTransfer.files;if(extensionIsOk(files))
loadFiles(files);}
function loadFileFromDisk(event){var files=event.target.files;if(extensionIsOk(files))
loadFiles(files);}
this.onDragEnter=function(event){event.preventDefault();};this.onDragOver=function(event){$(this).css('background-color','gray')
event.stopPropagation();event.preventDefault();event.dataTransfer.dropEffect='copy';};this.onDragLeave=function(event){$(this).css('background-color','transparent')
event.preventDefault();};this.onDrop=function(event){event.preventDefault();event.stopPropagation();loadFileFromDrop(event);};function setupDragDropEvents(){if(!Modernizr.draganddrop){toastr.error('Drag&Drop is not supproted on this browser','Error');return;}
var fileDrop=$("#fileDropDiv")[0];if(fileDrop!==undefined){fileDrop.addEventListener("dragenter",_this.onDragEnter,false);fileDrop.addEventListener("dragover",_this.onDragOver,false);fileDrop.addEventListener("dragleave",_this.onDragLeave,false);fileDrop.addEventListener("drop",_this.onDrop,false);}};function setupFileLoadEvents(){var loader=$("#fileLoader");if(loader!==undefined)
loader.bind("change",loadFileFromDisk);};function compatibilityChecks(){if(!Modernizr.webgl){toastr.error('WebGL is not supproted in this browser','Error');return undefined;}
else if(!window.File||!window.FileReader||!window.FileList||!window.Blob){toastr.error('The File API is not  supported in this browser.','Error');return false;}
else if(!Modernizr.localstorage){toastr.error('Local storage is not supported in this browser.','Error');return false;}
return true;}
this.loadSampleModelPreview=function(completeCallback){var complete=completeCallback;$.ajax({url:'../Stl/GetSavedModelPreview/first',success:function(data){if(complete!==undefined)
complete(true);if(data!==false){$("#sample_preview").css('visibility','visible');data.ModelName="View sample ( "+data.ModelName+" )";ko.applyBindings(data,$("#sample_preview")[0]);}},error:function(data){if(complete!==undefined)
complete(false);}});}
$(document).ready(function(){if(compatibilityChecks()){setupDragDropEvents();setupFileLoadEvents();_this.loadSampleModelPreview();userAccess.UpdateUI();$('#access').on('click',function(){userAccess.requestUserAuth();});}});})